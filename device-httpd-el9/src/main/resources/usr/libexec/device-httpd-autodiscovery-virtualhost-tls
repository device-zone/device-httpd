#!/bin/bash

if [ $# -eq 3 ]; then

  instance="${1}"
  virtualhost="${2}"
  line="${line}"

  if test -f "$line/server-name.txt"; then
    servername=$(head -n 1 $line/server-name.txt)
  else
    servername=$(hostname -f)
  fi

  install -m 750 -d "/run/httpd/device-${instance}"

  logger -t httpd-autodiscovery@${instance} "importing httpd server certificate/key..."

  redwax-tool --pem-in="/etc/pki/tls/private/*" \
              --pem-in="/etc/pki/tls/certs/ca-bundle.trust.crt" \
              --pem-in="/etc/pki/tls/certs/*.pem" \
              --filter=verify \
              --filter-hostname="${servername}" \
              --filter-current \
              --cert-out --chain-out --no-key-out \
              --pem-out="/run/httpd/device-${instance}/${virtualhost}.crt" \
              --no-cert-out --no-chain-out --key-out \
              --pem-out="/run/httpd/device-${instance}/${virtualhost}.key" || echo "Could not import cert/key for tls" > "${line}/error"

  if test ! -f "${line}/error"; then
    logger -t httpd-autodiscovery@${instance} "imported httpd server certificate/key for ${servername}."
  else
    logger -t httpd-autodiscovery@${instance} "failed to import httpd server certificate/key for ${servername}."
  fi

  cat > "tls.conf" <<- EOF
# Generated by $0 on `date`
# DO NOT MODIFY THIS FILE - it will be overwritten on server restart.
#

EOF

  if test -f "/run/httpd/device-${instance}/${virtualhost}.crt" -a -f "/run/httpd/device-${instance}/${virtualhost}.key"; then
    cat >> "tls.conf" <<- EOF
<IfModule !ssl_module>
  LoadModule ssl_module modules/mod_ssl.so
</IfModule>

SSLEngine on
SSLCertificateFile /run/httpd/device-${instance}/${virtualhost}.crt
SSLCertificateKeyFile /run/httpd/device-${instance}/${virtualhost}.key
EOF

  fi

  install "tls.conf" "/etc/httpd/conf.d/device-${instance}/secure-${virtualhost}.d/"

fi
