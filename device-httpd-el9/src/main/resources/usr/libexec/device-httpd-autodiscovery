#!/bin/bash

#
# Apache httpd Server Autodiscovery
# =================================
#
# This script autogenerates any required httpd instances.

set -e
umask 0007


#
# Handle the cleanup
# ------------------
cleanup_before_exit () {
  if [ -d "${tmpdir}" ]; then
    rm -rf "${tmpdir}"
  fi
}
# be in a temporay workspace (this works on linux and macosx)
tmpdir=`mktemp -d 2>/dev/null || mktemp -d -t 'tmpdir'`
# trap catches the exit signal and runs the specified function
trap cleanup_before_exit EXIT
# be in our directory
cd "${tmpdir}"


#
# Per instance? Run all scripts

if [ $# -ne 0 ]; then

  instance="${1}"

  logger -t "httpd-autodiscovery@${instance}" "running autodiscovery for httpd server instance ${instance}..."

  find "$0.d" -type f -executable | sort | \
  while read x; do
    "$x" "${instance}" < /dev/null || touch error;
  done

  if test ! -f "error"; then
    logger -t "httpd-autodiscovery@${instance}" "completed autodiscovery for httpd server instance ${instance}."
    exit 0
  else
    logger -t "httpd-autodiscovery@${instance}" "failed autodiscovery for httpd server instance ${instance}."
    exit 1
  fi

fi


#
# Create instance that does not yet exist
create_instance() {
  instance="${1}"

  cat >> "device-${instance}.conf" <<- EOF
# Generated by $0 on `date`
# DO NOT MODIFY THIS FILE - it will be overwritten on server restart.
#

EOF

  install -m 640 "device-${instance}.conf" "/etc/httpd/device-${instance}.conf"
}


#
# Remove existing instance
remove_instance() {
  instance="${1}"

  rm -f "/etc/httpd/device-${instance}.conf"
}


#
# Add/remove httpd instances

find /etc/device/services/www/instance/ -mindepth 1 -maxdepth 1 -type l | \
while read line; do

  target=$(readlink -f "$line")

  if test ! -f "$line/name.txt"; then
    continue;
  fi
  instance="$(head $line/name.txt)"

  # add new instances
  if test -f "$line/added"; then

    # instance already exist and we're told to add? none of our business, remove the device config for safety
    if test -d "/etc/httpd/device-${instance}"; then

      logger -t httpd-autodiscovery "'/etc/httpd/device-${instance}' already exists, ignoring '$line'"
      echo "Webserver ${instance} already exists" > ${line}/error

      continue;
    fi

    logger -t httpd-autodiscovery "creating httpd server instance ${instance}..."
    create_instance "${instance}"
    logger -t httpd-autodiscovery "created httpd server instance ${instance}."

    if test -f "$line/disabled.bin"; then

      systemctl disable "httpd-autodiscovery@${instance}"
      systemctl disable "httpd@device-${instance}"
      systemctl disable "httpd-postdiscovery@${instance}"

      systemctl stop "httpd-autodiscovery@${instance}"
      systemctl stop "httpd@device-${instance}"
      systemctl stop "httpd-postdiscovery@${instance}"

    else

      systemctl enable "httpd-autodiscovery@${instance}"
      systemctl enable "httpd@device-${instance}"
      systemctl enable "httpd-postdiscovery@${instance}"

      systemctl start "httpd-autodiscovery@${instance}"
      systemctl start "httpd@device-${instance}"
      systemctl start "httpd-postdiscovery@${instance}"

    fi

    rm -f "$line/added"

  # update instances
  elif test -f "$line/updated"; then

    instance="$(head $line/name.txt)"

    if test -f "$line/disabled.bin"; then

      systemctl disable "httpd-autodiscovery@${instance}"
      systemctl disable "httpd@device-${instance}"
      systemctl disable "httpd-postdiscovery@${instance}"

      systemctl stop "httpd-autodiscovery@${instance}"
      systemctl stop "httpd@device-${instance}"
      systemctl stop "httpd-postdiscovery@${instance}"

    else

      systemctl enable "httpd-autodiscovery@${instance}"
      systemctl enable "httpd@device-${instance}"
      systemctl enable "httpd-postdiscovery@${instance}"

      systemctl start "httpd-autodiscovery@${instance}"
      systemctl start "httpd@device-${instance}"
      systemctl start "httpd-postdiscovery@${instance}"

    fi

    rm -f "$line/updated"

  # remove old instances
  elif test -f "$line/removed"; then

    logger -t httpd-autodiscovery "removing httpd server instance ${instance}..."

    systemctl disable "httpd-autodiscovery@${instance}"
    systemctl disable "httpd@device-${instance}"
    systemctl disable "httpd-postdiscovery@${instance}"

    systemctl stop "httpd-autodiscovery@${instance}"
    systemctl stop "httpd@device-${instance}"
    systemctl stop "httpd-postdiscovery@${instance}"

    remove_instance "${instance}"
    logger -t httpd-autodiscovery "removed httpd server instance ${instance}."

    # remove folder
    rm -f "${target}"/*
    rmdir "${target}"
    rm -f "${line}"

  fi

done


