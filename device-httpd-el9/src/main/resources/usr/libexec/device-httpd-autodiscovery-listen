#!/bin/bash

if [ $# -eq 2 ]; then

  instance="${1}"

  #
  # Handle listening sockets

    cat > "device-${instance}-listen.conf" <<- EOF
# Generated by $0 on `date`
# DO NOT MODIFY THIS FILE - it will be overwritten on server restart.
#

EOF

  find /etc/device/services/www/listen/ -mindepth 1 -maxdepth 1 -type l | \
  while read line; do

    if test ! -f "$line/instance.d/name.txt" -o "${instance}" != "$(head $line/instance.d/name.txt)"; then
      continue;
    fi
    if test ! -f "$line/name.txt"; then
      continue;
    fi

    address=""
    port=""
    tlsport=""

    found="yes"

    if test -f "${line}/address.txt"; then
      address="$(head ${line}/address.txt)"

      if test -f "${line}/port.txt"; then
        port="$(head ${line}/port.txt)"
        cat >> "device-${instance}-listen.conf" <<- EOF
# Listen configured from ${line}/address.txt and ${line}/port.txt
Listen ${address}:${port} http

EOF
      fi

      if test -f "${line}/tls-port.txt"; then
        tlsport="$(head ${line}/tls-port.txt)"
        cat >> "device-${instance}-listen.conf" <<- EOF
# Listen configured from ${line}/address.txt and ${line}/tls-port.txt
Listen ${address}:${tlsport} https

EOF
      fi

    else

      if test -f "${line}/port.txt"; then
        port="$(head ${line}/port.txt)"
        cat >> "device-${instance}-listen.conf" <<- EOF
# Listen configured from ${line}/port.txt
Listen ${port} http

EOF
      fi

      if test -f "${line}/tls-port.txt"; then
        tlsport="$(head ${line}/tls-port.txt)"
        cat >> "device-${instance}-listen.conf" <<- EOF
# Listen configured from ${line}/tls-port.txt
Listen ${tlsport} https

EOF
      fi

    fi

    #
    # catchall - no ports?
    if test -z "${port}" -a -z "${tlsport}"; then
      if test -z "${address}"; then
	cat >> "device-${instance}-listen.conf" <<- EOF
# Listen configured from ${line} with default ports
Listen 80 http
Listen 443 https

EOF
      else
        cat >> "device-${instance}-listen.conf" <<- EOF
# Listen configured from ${line}/address.txt with default ports
Listen ${address}:80 http
Listen ${address}:443 https

EOF
      fi
    fi

  done

  #
  # catchall - no listens?
  if test -z "${found}"; then
        cat >> "device-${instance}-listen.conf" <<- EOF
# No listen configuration, bind to localhost
Listen localhost:80 http

EOF
  fi

  install -m 640 "device-${instance}-listen.conf" "/etc/httpd/conf.d/device-${instance}"/listen.conf

fi

