#!/bin/bash


#
# Create instance that does not yet exist
create_instance() {
  instance="${1}"
  virtualhost="${2}"
  line="${3}"

  cat >> "secure-${virtualhost}.conf" <<- EOF
# Generated by $0 on `date`
# DO NOT MODIFY THIS FILE - it will be overwritten on server restart.
#

EOF

  cat >> "virtual-${virtualhost}.conf" <<- EOF
# Generated by $0 on `date`
# DO NOT MODIFY THIS FILE - it will be overwritten on server restart.
#

EOF

  if test -f "${line}/listen.d/address.txt"; then
    address="$(head ${line}/listen.d/address.txt)"
  else
    address="*"
  fi

  if test -f "${line}/listen.d/port.txt"; then
    listen="${address}:$(head -n 1 ${line}/listen.d/port.txt)"
  fi
  if test -f "${line}/listen.d/tls-port.txt"; then
    tlslisten="${address}:$(head -n 1 ${line}/listen.d/tls-port.txt)"
  fi

  if test -f "${line}/server-name.txt"; then
    servername="$(head -n 1 ${line}/server-name.txt)"
  fi

  if test -n "${tlslisten}"; then
    cat >> "secure-${virtualhost}.conf" <<- EOF
#
# Secure virtual host
<VirtualHost ${tlslisten}>

EOF

    if test -n "${servername}"; then
      cat >> "secure-${virtualhost}.conf" <<- EOF
  ServerName ${servername}
EOF
    fi

    cat >> "secure-${virtualhost}.conf" <<- EOF
  IncludeOptional /etc/httpd/conf.d/device-${instance}/secure-${virtualhost}.d/*.conf
</VirtualHost>
EOF
  fi

  if test -n "${listen}"; then
    cat >> "virtual-${virtualhost}.conf" <<- EOF
#
# Open virtual host
<VirtualHost ${listen}>

EOF

    if test -n "${servername}"; then
      cat >> "virtual-${virtualhost}.conf" <<- EOF
  ServerName ${servername}
EOF
    fi

    cat >> "virtual-${virtualhost}.conf" <<- EOF
  IncludeOptional /etc/httpd/conf.d/device-${instance}/virtualhost-${virtualhost}.d/*.conf
</VirtualHost>
EOF
  fi

  install -m 640 "virtual-${virtualhost}.conf" "/etc/httpd/conf.d/device-${instance}/virtual-${virtualhost}.conf"
  install -m 640 "secure-${virtualhost}.conf" "/etc/httpd/conf.d/device-${instance}/secure-${virtualhost}.conf"
  install -d 0750 "/etc/httpd/conf.d/device-${instance}/virtual-${virtualhost}.d/"
  install -d 0750 "/etc/httpd/conf.d/device-${instance}/secure-${virtualhost}.d/"
}


#
# Remove existing virtualhost
remove_instance() {
  instance="${1}"
  virtualhost="${2}"

  rm -f "/etc/httpd/conf.d/device-${instance}/virtual-${virtualhost}.conf"
  rm -f "/etc/httpd/conf.d/device-${instance}/secure-${virtualhost}.conf"
  rm -rf "/etc/httpd/conf.d/device-${instance}/virtual-${virtualhost}.d/"
  rm -rf "/etc/httpd/conf.d/device-${instance}/secure-${virtualhost}.d/"
}


#
# Per application? Run all scripts

run_scripts() {

  instance="${1}"
  virtualhost="${2}"
  line="${3}"

  logger -t "httpd-autodiscovery@${instance}" "generating virtualhosts for httpd instance ${instance}..."

  rm -f "${line}/warning"

  find "/usr/libexec/device-httpd-autodiscovery.d/virtualhost.d" -type f -executable | sort | \
  while read x; do
    "$x" "${instance}" "${virtualhost}" "${line}" < /dev/null || touch error;
  done

  if test ! -f "error"; then
    logger -t "httpd-autodiscovery@${instance}" "completed virtualhosts for httpd instance ${instance}."
  else
    logger -t "httpd-autodiscovery@${instance}" "failed virtualhosts for httpd instance ${instance}."
  fi

}

if [ $# -eq 2 ]; then

  instance="${1}"

  #
  # Handle virtual hosts

  # find /etc/device/services/www/virtualhost/ -mindepth 1 -maxdepth 1 -type l
  while read line; do

    if test ! -f "$line/listen.d/instance.d/name.txt" -o "${instance}" != "$(head $line/listen.d/instance.d/name.txt)"; then
      continue;
    fi
    if test ! -f "$line/name.txt"; then
      continue;
    fi

    target=$(readlink -f "$line")

    instance="$(head -n 1 $line/listen.d/instance.d/name.txt)"
    virtualhost="$(head -n 1 $line/name.txt)"

    # remove old instances
    if test -f "$line/removed"; then

      logger -t httpd-autodiscovery "removing virtualhost from httpd server instance ${instance}..."
      remove_instance "${instance}" "${virtualhost}"
      logger -t httpd-autodiscovery "removed virtualhost from httpd server instance ${instance}."

      # remove folder
      rm -f "${target}"/*
      rmdir "${target}"
      rm -f "${line}"

    # add new instances
    elif test -f "$line/added"; then

      # instance already exist and we're told to add? none of our business, remove the device config for safety
      if test -d "/etc/httpd/conf.d/device-${instance}/virtualhost-${virtualhost}.d/"; then

        logger -t httpd-autodiscovery "'"/etc/httpd/conf.d/device-${instance}/virtualhost-${virtualhost}.d/"' already exists, ignoring '$line'"
        echo "Virtualhost ${virtualhost} already exists" > ${line}/error

        continue;
      fi

      logger -t httpd-autodiscovery "creating virtualhost in httpd server instance ${instance}..."
      create_instance "${instance}" "${virtualhost}" "${line}"
      run_scripts "${instance}" "${virtualhost}" "${line}"
      logger -t httpd-autodiscovery "created virtualhost in httpd server instance ${instance}."

      rm -f "$line/added"

    # update instances
    elif test -f "$line/updated"; then

      run_scripts "${instance}" "${virtualhost}" "${line}"

      rm -f "$line/updated"

    # something we depend on changed
    else

      run_scripts "${instance}" "${virtualhost}" "${line}"

    fi

  done < <(find /etc/device/services/www/virtualhost/ -mindepth 1 -maxdepth 1 -type l)

#  install -m 640 "device-${instance}-listen.conf" "/etc/httpd/conf.d/device-${instance}"/listen.conf

fi


