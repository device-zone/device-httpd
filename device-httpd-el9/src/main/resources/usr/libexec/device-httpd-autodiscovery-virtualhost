#!/bin/bash

#
# Per application? Run all scripts

run_scripts() {

  instance="${1}"
  virtualhost="${2}"
  line="${3}"

  logger -t "httpd-autodiscovery@${instance}" "generating virtualhosts for httpd instance ${instance}..."

  rm -f "${line}/warning"

  find "/usr/libexec/device-httpd-autodiscovery-virtualhost.d" -type f -executable | sort | \
  while read x; do
    "$x" "${instance}" "${virtualhost}" "${line}" < /dev/null || touch error;
  done

  if test ! -f "error"; then
    logger -t "httpd-autodiscovery@${instance}" "completed virtualhosts for httpd instance ${instance}."
  else
    logger -t "httpd-autodiscovery@${instance}" "failed virtualhosts for httpd instance ${instance}."
  fi

}


#
# Enable instance that does not yet exist
enable_instance() {
  instance="${1}"
  virtualhost="${2}"
  line="${3}"

  if test -f "${line}/listen.d/address.txt"; then
    address="$(head ${line}/listen.d/address.txt)"
  else
    address="*"
  fi

  if test -f "${line}/listen.d/port.txt"; then
    listen="${address}:$(head -n 1 ${line}/listen.d/port.txt)"
  fi
  if test -f "${line}/listen.d/tls-port.txt"; then
    tlslisten="${address}:$(head -n 1 ${line}/listen.d/tls-port.txt)"
  fi

  if test -f "$line/server-name.txt"; then
    servername=$(head -n 1 $line/server-name.txt)
  else
    servername=$(hostname -f)
  fi

  if test -n "${tlslisten}"; then

    install -m 750 -d "/run/httpd/device-${instance}"

    logger -t httpd-autodiscovery@${instance} "importing httpd server certificate/key..."

    redwax-tool --pem-in="/etc/pki/tls/private/*" \
                --pem-in="/etc/pki/tls/certs/ca-bundle.trust.crt" \
                --pem-in="/etc/pki/tls/certs/*.pem" \
                --filter=verify \
                --filter-hostname="${servername}" \
                --filter-current \
                --cert-out --chain-out --no-key-out \
                --pem-out="/run/httpd/device-${instance}/${virtualhost}.crt" \
                --no-cert-out --no-chain-out --key-out \
                --pem-out="/run/httpd/device-${instance}/${virtualhost}.key" || echo "Could not import cert/key for tls" > "${line}/error"

    if test ! -f "${line}/error"; then
      logger -t httpd-autodiscovery@${instance} "imported httpd server certificate/key for ${servername}."
    else
      logger -t httpd-autodiscovery@${instance} "failed to import httpd server certificate/key for ${servername}. Skipping virtualhost."

      # give up and skip virtual host creation
      return
    fi

  fi

  cat >> "secure-${virtualhost}.conf" <<- EOF
# Generated by $0 on `date`
# DO NOT MODIFY THIS FILE - it will be overwritten on server restart.
#

EOF

  cat >> "virtual-${virtualhost}.conf" <<- EOF
# Generated by $0 on `date`
# DO NOT MODIFY THIS FILE - it will be overwritten on server restart.
#

EOF

  #
  # Handle secure host
  if test -n "${tlslisten}"; then

    cat >> "secure-${virtualhost}.conf" <<- EOF
<IfModule !ssl_module>
  LoadModule ssl_module modules/mod_ssl.so
</IfModule>

#
# Secure virtual host
<VirtualHost ${tlslisten}>

EOF

    if test -n "${servername}"; then
      cat >> "secure-${virtualhost}.conf" <<- EOF
  ServerName ${servername}

EOF
    fi

    cat >> "secure-${virtualhost}.conf" <<- EOF
  SSLEngine on
  SSLCertificateFile /run/httpd/device-${instance}/${virtualhost}.crt
  SSLCertificateKeyFile /run/httpd/device-${instance}/${virtualhost}.key

  IncludeOptional /etc/httpd/conf.d/device-${instance}/secure-${virtualhost}.d/*.conf
</VirtualHost>
EOF
  fi

  if test -n "${listen}"; then
    cat >> "virtual-${virtualhost}.conf" <<- EOF
#
# Open virtual host
<VirtualHost ${listen}>

EOF

    if test -n "${servername}"; then
      cat >> "virtual-${virtualhost}.conf" <<- EOF
  ServerName ${servername}
EOF
    fi

    cat >> "virtual-${virtualhost}.conf" <<- EOF
  IncludeOptional /etc/httpd/conf.d/device-${instance}/virtualhost-${virtualhost}.d/*.conf
</VirtualHost>
EOF
  fi

  install -m 640 "virtual-${virtualhost}.conf" "/etc/httpd/conf.d/device-${instance}/virtual-${virtualhost}.conf"
  install -m 640 "secure-${virtualhost}.conf" "/etc/httpd/conf.d/device-${instance}/secure-${virtualhost}.conf"
  install -d 0750 "/etc/httpd/conf.d/device-${instance}/virtual-${virtualhost}.d/"
  install -d 0750 "/etc/httpd/conf.d/device-${instance}/secure-${virtualhost}.d/"

  run_scripts "${instance}" "${virtualhost}" "${line}"
}


#
# Disable existing virtualhost
disable_instance() {
  instance="${1}"
  virtualhost="${2}"

  rm -f "/etc/httpd/conf.d/device-${instance}/virtual-${virtualhost}.conf"
  rm -f "/etc/httpd/conf.d/device-${instance}/secure-${virtualhost}.conf"
  rm -rf "/etc/httpd/conf.d/device-${instance}/virtual-${virtualhost}.d/"
  rm -rf "/etc/httpd/conf.d/device-${instance}/secure-${virtualhost}.d/"
}


if [ $# -eq 2 ]; then

  instance="${1}"

  #
  # Handle virtual hosts

  # find /etc/device/services/www/virtualhost/ -mindepth 1 -maxdepth 1 -type l
  while read line; do

    if test ! -f "$line/listen.d/instance.d/name.txt" -o "${instance}" != "$(head $line/listen.d/instance.d/name.txt)"; then
      continue;
    fi
    if test ! -f "$line/name.txt"; then
      continue;
    fi

    target=$(readlink -f "$line")

    instance="$(head -n 1 $line/listen.d/instance.d/name.txt)"
    virtualhost="$(head -n 1 $line/name.txt)"

    # remove old instances
    if test -f "$line/removed"; then

      logger -t httpd-autodiscovery "removing virtualhost from httpd server instance ${instance}..."
      disable_instance "${instance}" "${virtualhost}"
      logger -t httpd-autodiscovery "removed virtualhost from httpd server instance ${instance}."

      # remove folder
      rm -f "${target}"/*
      rmdir "${target}"
      rm -f "${line}"

    # update to disabled state
    elif test -f "$line/disabled.bin"; then

      logger -t httpd-autodiscovery "disabling virtualhost from httpd server instance ${instance}..."
      disable_instance "${instance}" "${virtualhost}"
      logger -t httpd-autodiscovery "disabled virtualhost from httpd server instance ${instance}."

      rm -f "$line/added"

    # update to enabled state
    else

      logger -t httpd-autodiscovery "creating virtualhost in httpd server instance ${instance}..."
      enable_instance "${instance}" "${virtualhost}" "${line}"
      run_scripts "${instance}" "${virtualhost}" "${line}"
      logger -t httpd-autodiscovery "created virtualhost in httpd server instance ${instance}."

      rm -f "$line/updated"

    fi

  done < <(find /etc/device/services/www/virtualhost/ -mindepth 1 -maxdepth 1 -type l)

fi


