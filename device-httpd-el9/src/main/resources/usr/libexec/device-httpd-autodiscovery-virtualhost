#!/bin/bash

#
# Per application? Run all scripts

run_scripts() {

  instance="${1}"
  virtualhost="${2}"
  line="${3}"

  logger -t "httpd-autodiscovery@${instance}" "generating virtualhosts for httpd instance ${instance}..."

  rm -f "${line}/warning"

  find "/usr/libexec/device-autodiscovery/httpd-virtualhost.d" -type f -executable | sort | \
  while read x; do
    "$x" "${instance}" "${virtualhost}" "${line}" < /dev/null || touch error;
  done

  if test ! -f "error"; then
    logger -t "httpd-autodiscovery@${instance}" "completed virtualhosts for httpd instance ${instance}."
  else
    logger -t "httpd-autodiscovery@${instance}" "failed virtualhosts for httpd instance ${instance}."
  fi

}


#
# Create instance that does not yet exist
create_instance() {
  instance="${1}"
  virtualhost="${2}"
  line="${3}"

  if test -f "${line}/listen.d/address.txt"; then
    address="$(head ${line}/listen.d/address.txt)"
  else
    address="*"
  fi

  if test -f "${line}/listen.d/port.txt"; then
    listen="${address}:$(head -n 1 ${line}/listen.d/port.txt)"
  fi
  if test -f "${line}/listen.d/tls-port.txt"; then
    tlslisten="${address}:$(head -n 1 ${line}/listen.d/tls-port.txt)"
  fi

  if test -f "$line/server-name.txt"; then
    servername=$(head -n 1 $line/server-name.txt)
  else
    servername=$(hostname -f)
  fi

  if test -f "${line}/tls-verify.txt"; then
    tlsverify="$(head -n 1 ${line}/tls-verify.txt)"
  fi

  if test -f "${line}/tls-ca-certs.crt"; then
    tlscacerts=$(readlink -f "$line/tls-ca-certs.crt")
  fi

  install -m 2770 -g apache -d "/var/www/instance/${instance}"
  install -m 2770 -g apache -d "/var/www/instance/${instance}/secure"
  install -m 2770 -g apache -d "/var/www/instance/${instance}/secure/${virtualhost}"
  install -m 2770 -g apache -d "/var/www/instance/${instance}/secure/${virtualhost}/web-docs"
  install -m 2770 -g apache -d "/var/www/instance/${instance}/virtual"
  install -m 2770 -g apache -d "/var/www/instance/${instance}/virtual/${virtualhost}"
  install -m 2770 -g apache -d "/var/www/instance/${instance}/virtual/${virtualhost}/web-docs"

  semanage fcontext -a -t httpd_sys_rw_content_t "/var/www/instance/${instance}/secure/${virtualhost}/web-docs(/.*)?"
  semanage fcontext -a -t httpd_sys_rw_content_t "/var/www/instance/${instance}/virtual/${virtualhost}/web-docs(/.*)?"

  restorecon -R "/var/www/instance/${instance}/secure/${virtualhost}/web-docs"
  restorecon -R "/var/www/instance/${instance}/virtual/${virtualhost}/web-docs"

  if test -n "${tlslisten}"; then

    logger -t httpd-autodiscovery@${instance} "importing httpd server certificate/key..."

    install -m 0710 -u root -g apache -d "/run/httpd/instance-device-${instance}"

    redwax-tool --pem-in="/etc/pki/tls/private/*" \
                --pem-in="/etc/pki/tls/certs/ca-bundle.trust.crt" \
                --pem-in="/etc/pki/tls/certs/*.pem" \
                --filter=verify \
                --filter-hostname="${servername}" \
                --filter-current \
                --cert-out --chain-out --no-key-out \
                --pem-out="/run/httpd/instance-device-${instance}/${virtualhost}.crt" \
                --no-cert-out --no-chain-out --key-out \
                --pem-out="/run/httpd/instance-device-${instance}/${virtualhost}.key" || echo "Could not import cert/key for tls" > "${line}/error"

    if test ! -f "${line}/error"; then
      logger -t httpd-autodiscovery@${instance} "imported httpd server certificate/key for ${servername}."
    else
      logger -t httpd-autodiscovery@${instance} "failed to import httpd server certificate/key for ${servername}. Skipping virtualhost."

      # give up and skip virtual host creation
      return
    fi

    if test -n "${tlsverify}"; then

      if test -z "${tlscacerts}"; then

        logger -t httpd-autodiscovery@${instance} "tls-verify set but no tls-ca-certs set for ${servername}. Skipping virtualhost."

        # give up and skip virtual host creation
	return
      fi

    fi

  fi

  cat >> "secure-${virtualhost}.conf" <<- EOF
# Generated by $0 on `date`
# DO NOT MODIFY THIS FILE - it will be overwritten on server restart.
#

EOF

  cat >> "virtual-${virtualhost}.conf" <<- EOF
# Generated by $0 on `date`
# DO NOT MODIFY THIS FILE - it will be overwritten on server restart.
#

EOF

  #
  # Handle secure host
  if test -n "${tlslisten}"; then

    cat >> "secure-${virtualhost}.conf" <<- EOF
<IfModule !log_config_module>
  LoadModule log_config_module modules/mod_log_config.so
</IfModule>
<IfModule !ssl_module>
  LoadModule ssl_module modules/mod_ssl.so
</IfModule>

#
# Secure virtual host
<VirtualHost ${tlslisten}>

  DocumentRoot "/var/www/instance/${instance}/secure/${virtualhost}/web-docs"
  LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\" \"%{SSL_CLIENT_S_DN}x\" \"%{SSL_CLIENT_I_DN}x\"" ssl-combined
  ErrorLog /var/log/httpd/device-${instance}-secure-${virtualhost}-error_log
  CustomLog /var/log/httpd/device-${instance}-secure-${virtualhost}-access_log ssl-combined

EOF

    if test -n "${servername}"; then
      cat >> "secure-${virtualhost}.conf" <<- EOF
  ServerName ${servername}

EOF
    fi

    cat >> "secure-${virtualhost}.conf" <<- EOF
  SSLEngine on

  SSLCipherSuite PROFILE=SYSTEM
  SSLProxyCipherSuite PROFILE=SYSTEM

  SSLCertificateFile /run/httpd/instance-device-${instance}/${virtualhost}.crt
  SSLCertificateKeyFile /run/httpd/instance-device-${instance}/${virtualhost}.key

EOF

    if test -n "${tlsverify}" -a -n "${tlscacerts}"; then
      cat >> "secure-${virtualhost}.conf" <<- EOF
  SSLVerifyClient ${tlsverify}
  SSLVerifyDepth 10
  SSLCACertificateFile "${tlscacerts}"

EOF
    fi

    cat >> "secure-${virtualhost}.conf" <<- EOF
  IncludeOptional /etc/httpd/conf.device.d/instance/${instance}/secure-${virtualhost}.d/*.conf
EOF

    if test -n "${servername}"; then
      cat >> "secure-${virtualhost}.conf" <<- EOF
  IncludeOptional /etc/httpd/conf.device.d/secure/${servername}/*.conf
EOF
    fi

    cat >> "secure-${virtualhost}.conf" <<- EOF
</VirtualHost>
EOF

  fi

  if test -n "${listen}"; then
    cat >> "virtual-${virtualhost}.conf" <<- EOF
#
# Open virtual host
<VirtualHost ${listen}>

  DocumentRoot "/var/www/instance/${instance}/virtual/${virtualhost}/web-docs"

EOF

    if test -n "${servername}"; then
      cat >> "virtual-${virtualhost}.conf" <<- EOF
  ServerName ${servername}
EOF
    fi

    cat >> "virtual-${virtualhost}.conf" <<- EOF
  IncludeOptional /etc/httpd/conf.device.d/instance/${instance}/virtualhost-${virtualhost}.d/*.conf
EOF

    if test -n "${servername}"; then
      cat >> "virtual-${virtualhost}.conf" <<- EOF
  IncludeOptional /etc/httpd/conf.device.d/virtual/${servername}/*.conf
EOF
    fi

    cat >> "virtual-${virtualhost}.conf" <<- EOF
</VirtualHost>
EOF

  fi

  rm -rf "/etc/httpd/conf.device.d/instance/${instance}/virtual-${virtualhost}.d/"
  rm -rf "/etc/httpd/conf.device.d/instance/${instance}/secure-${virtualhost}.d/"
  install -m 0750 -d "/etc/httpd/conf.device.d/instance/${instance}/virtual-${virtualhost}.d/"
  install -m 0750 -d "/etc/httpd/conf.device.d/instance/${instance}/secure-${virtualhost}.d/"

  run_scripts "${instance}" "${virtualhost}" "${line}"

  if test -f "$line/disabled.bin"; then
    install -m 640 "virtual-${virtualhost}.conf" "/etc/httpd/conf.device.d/instance/${instance}/virtual-${virtualhost}.conf-disabled"
    install -m 640 "secure-${virtualhost}.conf" "/etc/httpd/conf.device.d/instance/${instance}/secure-${virtualhost}.conf-disabled"
  else
    install -m 640 "virtual-${virtualhost}.conf" "/etc/httpd/conf.device.d/instance/${instance}/virtual-${virtualhost}.conf"
    install -m 640 "secure-${virtualhost}.conf" "/etc/httpd/conf.device.d/instance/${instance}/secure-${virtualhost}.conf"
  fi

}


#
# Remove instance that exists
remove_instance() {
  instance="${1}"
  virtualhost="${2}"

  semanage fcontext -d -t httpd_sys_rw_content_t "/var/www/instance/${instance}/secure/${virtualhost}/web-docs(/.*)?"
  semanage fcontext -d -t httpd_sys_rw_content_t "/var/www/instance/${instance}/virtual/${virtualhost}/web-docs(/.*)?"

  rm -f "/etc/httpd/conf.device.d/instance/${instance}/virtual-${virtualhost}.conf"
  rm -f "/etc/httpd/conf.device.d/instance/${instance}/secure-${virtualhost}.conf"
  rm -rf "/etc/httpd/conf.device.d/instance/${instance}/virtual-${virtualhost}.d/"
  rm -rf "/etc/httpd/conf.device.d/instance/${instance}/secure-${virtualhost}.d/"
}


if [ $# -eq 2 ]; then

  instance="${1}"

  #
  # Handle virtual hosts

  # find /etc/device/services/www/virtualhost/ -mindepth 1 -maxdepth 1 -type l
  while read line; do

    if test ! -f "$line/listen.d/instance.d/name.txt" -o "${instance}" != "$(head $line/listen.d/instance.d/name.txt)"; then
      continue;
    fi
    if test ! -f "$line/name.txt"; then
      continue;
    fi

    target=$(readlink -f "$line")

    instance="$(head -n 1 $line/listen.d/instance.d/name.txt)"
    virtualhost="$(head -n 1 $line/name.txt)"

    # remove old instances
    if test -f "$line/removed"; then

      logger -t httpd-autodiscovery "removing virtualhost from httpd server instance ${instance}..."
      remove_instance "${instance}" "${virtualhost}"
      logger -t httpd-autodiscovery "removed virtualhost from httpd server instance ${instance}."

      # remove folder
      rm -f "${target}"/*
      rmdir "${target}"
      rm -f "${line}"

    # add new instances
    elif test -f "$line/added"; then

      logger -t httpd-autodiscovery "creating virtualhost in httpd server instance ${instance}..."
      create_instance "${instance}" "${virtualhost}" "${line}"
      logger -t httpd-autodiscovery "created virtualhost in httpd server instance ${instance}."

      rm -f "$line/added"

    # update instances
    elif test -f "$line/updated"; then

      logger -t httpd-autodiscovery "updating virtualhost in httpd server instance ${instance}..."
      remove_instance "${instance}" "${virtualhost}"
      create_instance "${instance}" "${virtualhost}" "${line}"
      logger -t httpd-autodiscovery "updated virtualhost in httpd server instance ${instance}."

      rm -f "$line/updated"

    # update to enabled state
    else

      logger -t httpd-autodiscovery "updating virtualhost in httpd server instance ${instance}..."
      remove_instance "${instance}" "${virtualhost}" 
      create_instance "${instance}" "${virtualhost}" "${line}"
      logger -t httpd-autodiscovery "updated virtualhost in httpd server instance ${instance}."

    fi

  done < <(find /etc/device/services/www/virtualhost/ -mindepth 1 -maxdepth 1 -type l)

fi


