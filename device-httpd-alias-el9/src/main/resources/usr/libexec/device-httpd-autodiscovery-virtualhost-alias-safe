#!/bin/bash

if [ $# -eq 3 ]; then

  instance="${1}"
  virtualhost="${2}"

  #
  # Handle alias safe locations

  # find /etc/device/services/www/safe/alias/ -mindepth 1 -maxdepth 1 -type l
  while read line; do

    if test ! -f "$line/virtualhost.d/listen.d/instance.d/name.txt" -o "${instance}" != "$(head -n 1 $line/virtualhost.d/listen.d/instance.d/name.txt)"; then
      continue;
    fi
    if test ! -f "$line/virtualhost.d/name.txt" -o "${virtualhost}" != "$(head -n 1 $line/virtualhost.d/name.txt)"; then
      continue;
    fi
    if test ! -f "$line/name.txt"; then
      continue;
    fi
    if test ! -L "$line/directory"; then
      continue;
    fi
    location="$(head -n 1 ${line}/name.txt)"
    directory="$(readlink -f ${line}/directory || continue)"

    # read server-name if present
    if test -f "$line/virtualhost.d/server-name.txt"; then
      servername="$(head -n 1 $line/virtualhost.d/server-name.txt)"
    else
      servername="$(hostname -f)"
    fi

    # read in the path if present
    path=""
    if test -f "${line}/path.txt"; then
      path="$(head -n 1 ${line}/path.txt)"
    fi
    # empty path becomes a /
    if test -z "${path}";then
      path="/"
    fi

    # remove for safety
    rm -f "/etc/httpd/conf.device.d/instance/${instance}/secure-${virtualhost}.d/location-$(echo ${path} | tr [:cntrl:][:punct:] _).conf"

    # read auth if present
    # Note: "safe" MUST NOT be open, MUST be safe, and MAY be misconfigured
    authname=""
    if test -f "$line/auth.d/name.txt"; then
      authname="$(head -n 1 $line/auth.d/name.txt)"
    fi
    if test -z "${authname}"; then
      continue;
    fi

    # access url if present
    access_url=""
    access_text=""
    if test -f "$line/access-url.txt"; then
      access_url="$(head -n 1 ${line}/access-url.txt)"
      if test -n "${access_url}"; then
        access_text=" To request access, <a href='$(echo ${access_url} | recode ..html)'>click here</a>."
      fi
    fi

    cat > "location.conf" <<- EOF
# Generated by $0 on `date`
# DO NOT MODIFY THIS FILE - it will be overwritten on server restart.
#
# To override this file, add configuration to the following location:
# /etc/httpd/conf.device.d/secure/${servername}/*.conf
#

<IfModule !alias_module>
  LoadModule alias_module modules/mod_alias.so
</IfModule>
<IfModule !authz_core_module>
  LoadModule authz_core_module modules/mod_authz_core.so
</IfModule>
<IfModule !autoindex_module>
  LoadModule autoindex_module modules/mod_autoindex.so
</IfModule>
<IfModule !dir_module>
  LoadModule dir_module modules/mod_dir.so
</IfModule>

# Locked alias configured from ${line}/path.txt

# This style of config is broken in httpd 2.4 - suffix is lost
#  <Location ${path}>
#    Alias ${directory}
#  </Location>

Alias ${path} ${directory}
<Directory ${directory}>
  Options +Indexes

  IndexOptions FancyIndexing HTMLTable VersionSort XHTML
  DirectoryIndex index.html
  FileETag INode MTime Size

  AuthzSendForbiddenOnFailure on

  <If "%{SSL_CLIENT_VERIFY} == 'SUCCESS' || %{SSL_CLIENT_VERIFY} == 'GENEROUS'">

    SSLUserName SSL_CLIENT_CERT_RFC4523_CEA

EOF

    if test -n "${authname}"; then
      cat >> "location.conf" <<- EOF
    require device-${authname}

    ErrorDocument 403 "<html><head><title>403 Forbidden</title></head><body><h1>Forbidden</h1><p>Your gadget '%{SSL_CLIENT_S_DN_CN}' currently does not have permission to access this URL.${access_text}</p></body></html>"

EOF
    else
      cat >> "location.conf" <<- EOF
    # no authname specified, so access is denied
    require all denied

    ErrorDocument 403 "<html><head><title>403 Forbidden</title></head><body><h1>Forbidden</h1><p>Access is currently disabled for this URL space.</p></body></html>"
EOF
    fi

    cat >> "location.conf" <<- EOF
  </If>
  <Else>
    require all denied

    ErrorDocument 403 "<html><head><title>403 Forbidden</title></head><body><h1>Forbidden</h1><p>A digital certificate is required to access this URL, but none was provided. Did you click cancel?${access_text}</p></body></html>"

  </Else>
</Directory>
EOF

    install "location.conf" "/etc/httpd/conf.device.d/instance/${instance}/secure-${virtualhost}.d/location-$(echo ${path} | tr [:cntrl:][:punct:] _).conf"

  done < <(find /etc/device/services/www/safe/alias/ -mindepth 1 -maxdepth 1 -type l)

fi


