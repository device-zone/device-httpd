#!/bin/bash
  
if [ $# -eq 2 ]; then

  instance="${1}"
  line="${2}"

  cat > "device-${instance}-auth.conf" <<- EOF
# Generated by $0 on `date`
# DO NOT MODIFY THIS FILE - it will be overwritten on server restart.
#

<IfModule !authz_core_module>
  LoadModule authz_core_module modules/mod_authz_core.so
</IfModule>
<IfModule !ldap_module>
  LoadModule ldap_module modules/mod_ldap.so
</IfModule>
<IfModule !authnz_ldap_module>
  LoadModule authnz_ldap_module modules/mod_authnz_ldap.so
</IfModule>

EOF

  #
  # Handle authentication / authorisation
  
  # find /etc/device/services/www/auth/ -mindepth 1 -maxdepth 1 -type l
  while read line; do

    if test ! -f "$line/name.txt"; then
      continue;
    fi
    authname="$(head ${line}/name.txt)"

    # ldap instance if present
    ldap_instance=""
    if test -f "$line/ldap-suffix.d/instance.d/name.txt"; then
      ldap_instance="$(head -n 1 $line/ldap-suffix.d/instance.d/name.txt)"
    fi
    # ldap suffix if present
    ldap_suffix=""
    if test -f "$line/ldap-suffix.d/suffix.txt"; then
      ldap_suffix="$(head -n 1 $line/ldap-suffix.d/suffix.txt)"
    fi
    # ldap group if present
    ldap_group=""
    if test -f "$line/ldap-group.txt"; then
      ldap_group="$(head -n 1 ${line}/ldap-group.txt)"
    fi

    cat >> "device-${instance}-auth.conf" <<- EOF

# Authentication / authorization configured from ${line}/name.txt

EOF

    if test -n "${ldap_group}"; then

      if test -n "${ldap_instance}" -a -n "${ldap_suffix}"; then
        cat >> "device-${instance}-auth.conf" <<- EOF

<AuthzProviderAlias ldap-group device-${authname} "${ldap_group}">
  LDAPBind mechanism EXTERNAL
  AuthLDAPURL ldapi://%2frun%2fslapd-${ldap_instance}.socket/${ldap_suffix}?uid,inetSubscriberAccountId?sub?inetSubscriberAccountId=*
</AuthzProviderAlias>
EOF
      else
        cat >> "device-${instance}-auth.conf" <<- EOF
# device-${authname}: ldap-group "${ldap_group}" but no LDAP instance "${ldap_instance}" / suffix "${ldap_suffix}" specified, ignoring
<AuthzProviderAlias all device-${authname} denied>
</AuthzProviderAlias>
EOF
      fi

    else

      if test -n "${ldap_instance}" -a -n "${ldap_suffix}"; then
        cat >> "device-${instance}-auth.conf" <<- EOF

<AuthzProviderAlias valid-user device-${authname}>
  LDAPBind mechanism EXTERNAL
  AuthLDAPURL ldapi://%2frun%2fslapd-${ldap_instance}.socket/${ldap_suffix}?uid,inetSubscriberAccountId?sub?inetSubscriberAccountId=*
</AuthzProviderAlias>
EOF
      else
        cat >> "device-${instance}-auth.conf" <<- EOF
# device-${authname}: no LDAP instance "${ldap_instance}" / suffix "${ldap_suffix}" specified, ignoring
<AuthzProviderAlias all device-${authname} denied>
</AuthzProviderAlias>
EOF
      fi

    fi


  done < <(find /etc/device/services/www/auth/ -mindepth 1 -maxdepth 1 -type l)


  install -m 640 "device-${instance}-auth.conf" "/etc/httpd/conf.device.d/instance/${instance}"/auth.conf

fi

