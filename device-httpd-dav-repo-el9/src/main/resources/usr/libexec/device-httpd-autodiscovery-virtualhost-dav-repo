#!/bin/bash -x

if [ $# -eq 3 ]; then

  instance="${1}"
  virtualhost="${2}"

  #
  # Handle dav repo locations
  
  # find /etc/device/services/www/repo/dav/ -mindepth 1 -maxdepth 1 -type l
  while read line; do

    if [ ! -e "$line/dav.d/virtualhost.d/listen.d/instance.d/name.txt" ]; then
      continue;
    fi
    if [ "${instance}" != "$(head $line/dav.d/virtualhost.d/listen.d/instance.d/name.txt)" ]; then
      continue;
    fi

    # read in the path if present
    path=""
    if test -f "${line}/dav.d/path.txt"; then
      path="$(head ${line}/dav.d/path.txt)"
    fi
    # empty path becomes a /
    if test -z "${path}";then
      path="/"
    fi

    if test -f "$line/disabled.bin"; then
      logger -t $0 "DAV repo disabled, ignoring: ${path}"
      continue;
    fi

    # read in the base directory of the dav drive
    if test ! -L "$line/dav.d/directory"; then
      continue;
    fi
    directory="$(readlink -m ${line}/dav.d/directory)"
    if test -z "${directory}"; then
      logger -t $0 "Warning: DAV repo points at a broken symlink, ignoring: ${line}/directory"
      continue;
    fi

    # read in the source if present
    source=""
    if test -f "${line}/source.txt"; then
      source="$(head ${line}/source.txt)"
    fi
    # empty path becomes a /
    if test -z "${source}";then
      source=""
    fi

    # read in the destination if present
    destinationrpm=""
    if test -f "${line}/destination-rpm.txt"; then
      destinationrpm="$(head ${line}/destination-rpm.txt)"
    fi

    cat >> "device-${instance}-${virtualhost}-${location}-dav-repo.conf" <<- EOF
# Generated by $0 on `date`
# DO NOT MODIFY THIS FILE - it will be overwritten on server restart.
#

# DAV repo configured from ${line}/dav.d/path.txt

# Process RPMs published below ${path}
EOF

    if test -n "${destinationrpm}"; then
      cat >> "device-${instance}-${virtualhost}-${location}-dav-repo.conf" <<- EOF
CustomLog "|/usr/libexec/device-reindex-dav-repo-rpm ${directory}/${source} ${directory}/${destinationrpm}" "%m %f"
EOF
    fi

    install "device-${instance}-${virtualhost}-${location}-dav-repo.conf" "/etc/httpd/conf.device.d/instance/${instance}/secure-${virtualhost}.d/location-$(echo ${path} | tr [:cntrl:][:punct:] _)-dav-repo.conf"

  done < <(find /etc/device/services/www/repo/dav/ -mindepth 1 -maxdepth 1 -type l)

fi


